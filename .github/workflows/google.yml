# This workflow will build a docker container, publish it to Google Container Registry, and deploy it to GKE when there is a push to the "main" branch.
#
# To configure this workflow:
#
# 1. Ensure that your repository contains the necessary configuration for your Google Kubernetes Engine cluster, including deployment.yml, kustomization.yml, service.yml, etc.
#
# 2. Create and configure a Workload Identity Provider for GitHub (https://github.com/google-github-actions/auth#setting-up-workload-identity-federation)
#
# 3. Change the values for the GAR_LOCATION, GKE_ZONE, GKE_CLUSTER, IMAGE, REPOSITORY and DEPLOYMENT_NAME environment variables (below).
#
# For more support on how to run the workflow, please visit https://github.com/google-github-actions/setup-gcloud/tree/master/example-workflows/gke-kustomize

name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
env:
  PROJECT_ID: ${{secrets.GKE_PROJECT}}
  GAR_LOCATION: us-central1 # TODO: update region of the Artifact Registry
  GKE_CLUSTER: git-actions-cluste # TODO: update to cluster name
  GKE_ZONE: us-central1 # TODO: update to cluster zone
  DEPLOYMENT_NAME: node-deployment # TODO: update to deployment name
  REPOSITORY: fernandoojeda7/git-actions # TODO: update to Artifact Registry docker repository
  IMAGE: gcr.io/thermal-loop-414917/node-app

jobs:
  setup-build-publish-deploy:
    name: Configurar, Compilar, Publicar y Desplegar
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: git checkout
        uses: actions/checkout@v3

      - id: auth
        name: Autenticar en Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - name: Configuración de Docker
        run: |-
          gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev

      # Obtener las credenciales de GKE para poder desplegar en el clúster
      - name: Configurar credenciales de GKE
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Configuración de Docker
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Obtener SHA del commit
        run: |
          GIT_COMMIT_SHA=$(git rev-parse HEAD)
          echo "SHA del commit actual: $GIT_COMMIT_SHA"
        shell: bash

      # Construir la imagen de Docker
      - name: Compilar
        run: |-
          docker build \
            --tag "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA" \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF="$GITHUB_REF" \
            .

      # Publicar la imagen de Docker en Docker Hub
      - name: Publicar
        run: |-
          docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA" \

      # Desplegar la imagen de Docker en el clúster de GKE
      - name: Desplegar
        run: |-
          kubectl apply -f app.yaml
          kubectl rollout status deployment/$DEPLOYMENT_NAME
          kubectl get services -o wide
